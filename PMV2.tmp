# ============================================
# EMOTIBOT - PMV2 (versiÃ³n corregida con emociÃ³n neutral)
# Chatbot con Firebase y Recomendaciones Personalizadas
# Universidad Continental - 2025
# ============================================

!pip install firebase_admin scikit-learn

import random
import time
from datetime import datetime
import firebase_admin
from firebase_admin import credentials, firestore
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.ensemble import RandomForestClassifier

# --------------------------------------------
# 1ï¸âƒ£ ConexiÃ³n con Firebase
# --------------------------------------------
if not firebase_admin._apps:
    cred = credentials.Certificate("/content/chatbot-78eec-firebase-adminsdk-fbsvc-5a688937c9.json")
    firebase_admin.initialize_app(cred)

db = firestore.client()
print("âœ… Conectado correctamente a Firebase")

# --------------------------------------------
# 2ï¸âƒ£ Base de entrenamiento (incluye emociÃ³n 'neutral')
# --------------------------------------------
frases = [
    # Tristeza / depresiÃ³n
    "Estoy deprimido", "Me siento mal", "Estoy desanimado", "No tengo ganas de nada",
    "Siento que nada tiene sentido", "Estoy sin energÃ­a", "Estoy triste y sin motivaciÃ³n",
    # Ansiedad
    "Estoy ansioso", "Me siento nervioso", "Tengo miedo", "Estoy preocupado",
    "No puedo dormir por ansiedad", "Estoy tenso", "Siento mucha presiÃ³n", "No puedo concentrarme",
    # Felicidad
    "Estoy feliz", "Todo va bien", "Me siento genial", "Estoy contento", "Hoy fue un gran dÃ­a",
    # Enojo
    "Estoy enojado", "Me siento molesto", "Estoy frustrado", "No quiero hablar con nadie",
    # Ayuda
    "Necesito ayuda", "No sÃ© quÃ© hacer", "Por favor apÃ³yame", "Me siento solo",
    # Neutral / saludo
    "hola", "buenos dÃ­as", "buenas tardes", "cÃ³mo estÃ¡s", "gracias", "quÃ© tal", "hola amigo", "buenas noches", "todo bien", "me cuentas algo"
]

emociones = [
    "triste", "triste", "triste", "triste", "triste", "triste", "triste",
    "ansioso", "ansioso", "ansioso", "ansioso", "ansioso", "ansioso", "ansioso", "ansioso",
    "feliz", "feliz", "feliz", "feliz", "feliz",
    "enojado", "enojado", "enojado", "enojado",
    "ayuda", "ayuda", "ayuda", "ayuda",
    "neutral", "neutral", "neutral", "neutral", "neutral", "neutral", "neutral", "neutral", "neutral", "neutral"
]

# Entrenar modelo
vectorizer = TfidfVectorizer(ngram_range=(1,2))
X = vectorizer.fit_transform(frases)
clf = RandomForestClassifier(n_estimators=500, random_state=42)
clf.fit(X, emociones)

print("ğŸ¤– Modelo entrenado correctamente con emociÃ³n 'neutral' incluida.")

# --------------------------------------------
# 3ï¸âƒ£ Recomendaciones personalizadas
# --------------------------------------------
recomendaciones = {
    "triste": [
        "Lamento que te sientas asÃ­ ğŸ˜”. Puedes tomar un descanso o hablar con alguien de confianza.",
        "Es normal sentirse triste a veces ğŸ’™. Estoy aquÃ­ para escucharte."
    ],
    "ansioso": [
        "Trata de respirar profundo unos segundos ğŸ§˜.",
        "Puedes relajarte con mÃºsica tranquila o una caminata corta ğŸŒ¿."
    ],
    "feliz": [
        "Â¡QuÃ© bueno! ğŸ˜„ Me alegra saberlo.",
        "Sigue disfrutando tu dÃ­a âœ¨."
    ],
    "enojado": [
        "Entiendo, la ira puede ser intensa ğŸ”¥. Tomar un respiro ayuda.",
        "Hablar o escribir sobre lo que te molesta puede aliviarte ğŸ’­."
    ],
    "ayuda": [
        "Estoy aquÃ­ para escucharte ğŸ¤. Â¿Quieres que te conecte con un especialista?",
        "No estÃ¡s solo, podemos buscar ayuda juntos ğŸ’¬."
    ],
    "neutral": [
        "Â¡Hola! ğŸ˜Š Â¿CÃ³mo te encuentras hoy?",
        "QuÃ© gusto saludarte ğŸ‘‹ Â¿CÃ³mo ha estado tu dÃ­a?",
        "Gracias por conversar conmigo ğŸ™Œ"
    ],
    "desconocido": [
        "Gracias por compartir. CuÃ©ntame un poco mÃ¡s para entenderte mejor ğŸ¤”."
    ]
}

# --------------------------------------------
# 4ï¸âƒ£ AnÃ¡lisis de emociÃ³n y riesgo
# --------------------------------------------
def analizar_texto(texto):
    X_new = vectorizer.transform([texto])
    emocion = clf.predict(X_new)[0]

    if emocion == "neutral":
        riesgo = random.randint(0, 10)
    elif emocion == "feliz":
        riesgo = random.randint(0, 25)
    elif emocion == "enojado":
        riesgo = random.randint(40, 60)
    elif emocion == "triste":
        riesgo = random.randint(60, 80)
    elif emocion == "ansioso":
        riesgo = random.randint(70, 90)
    elif emocion == "ayuda":
        riesgo = random.randint(80, 100)
    else:
        riesgo = random.randint(30, 70)
    return emocion, riesgo

# --------------------------------------------
# 5ï¸âƒ£ Guardar en Firebase
# --------------------------------------------
def guardar_en_firebase(usuario, mensaje, emocion, riesgo):
    data = {
        "usuario": usuario,
        "mensaje": mensaje,
        "emocion": emocion,
        "riesgo_emocional": riesgo,
        "fecha": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    }
    db.collection("conversaciones").add(data)
    time.sleep(1)
    print("ğŸ’¾ ConversaciÃ³n guardada en Firebase.")

# --------------------------------------------
# 6ï¸âƒ£ Chat principal
# --------------------------------------------
def chatbot():
    print("ğŸ’¬ EMOTIBOT PMV2 - VersiÃ³n Corregida (con 'neutral')")
    usuario = input("ğŸ‘¤ Ingresa tu nombre: ").strip()

    while True:
        texto = input("\nTÃº: ").strip()
        if texto.lower() in ["salir", "chao", "adios", "finalizar"]:
            print("ğŸ‘‹ Â¡CuÃ­date mucho, hasta luego!")
            break

        emocion, riesgo = analizar_texto(texto)
        respuesta = random.choice(recomendaciones.get(emocion, recomendaciones["desconocido"]))

        print(f"ğŸ¤– EMOTIBOT: {respuesta} (Riesgo emocional estimado: {riesgo}%)")

        guardar_en_firebase(usuario, texto, emocion, riesgo)

        if riesgo >= 80 and emocion != "neutral":
            print("ğŸš¨ Nivel alto detectado, te recomiendo contactar a un psicÃ³logo del directorio ğŸ“")

# --------------------------------------------
# 7ï¸âƒ£ Ejecutar chatbot
# --------------------------------------------
chatbot()
